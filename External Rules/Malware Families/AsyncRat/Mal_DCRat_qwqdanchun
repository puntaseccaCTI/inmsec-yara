source: Recorded Future https://app.recordedfuture.com/portal/research/insikt/doc:lH0Z-3
rule MAL_DcRat_qwqdanchun {
    meta:
        author = "CNANCE, Insikt Group, Recorded Future"
        date = "2021-12-29"
        description = "Detects DcRat (qwqdanchun version)"
        version = "1.0"
        reference = "https://github.com/qwqdanchun/DcRat"
        hash = "c30ccae0bb6832e6bf07185706dd4d63287d11eb8ac59cc278a26c2375778df7"
        RF_MALWARE = "DcRat (qwqdanchun version)"
        RF_MALWARE_ID = "qfQAi5"

    strings:
        // configuration settings
        $c0 = "SHA256" fullword wide
        $c1 = "%Ports%" fullword wide
        $c2 = "%Hosts%" fullword wide
        $c3 = "%Version%" fullword wide
        $c4 = "%Install%" fullword wide
        $c5 = "%Folder%" fullword wide
        $c6 = "%File%" fullword wide
        $c7 = "%Key%" fullword wide
        $c8 = "%MTX%" fullword wide
        $c9 = "%Certificate%" fullword wide
        $c10 = "%Serversignature%" fullword wide
        $c11 = "%Paste_bin%" fullword wide
        $c12 = "%BSOD%" fullword wide
        $c13 = "%Delay%" fullword wide
        $c14 = "%Group%" fullword wide
        $c15 = "%AntiProcess%" fullword wide
        $c16 = "%Anti%" fullword wide

        // configuration variables
        $d0 = "Por_ts" fullword ascii
        $d1 = "Hos_ts" fullword ascii
        $d2 = "Ver_sion" fullword ascii
        $d3 = "In_stall" fullword ascii
        $d4 = "Install_Folder" fullword ascii
        $d5 = "Install_File" fullword ascii
        $d6 = "Certifi_cate" fullword ascii
        $d7 = "Server_signa_ture" fullword ascii
        $d8 = "Server_Certificate" fullword ascii
        $d9 = "aes256" fullword ascii
        $d10 = "Paste_bin" fullword ascii
        $d11 = "BS_OD" fullword ascii
        $d12 = "Hw_id" fullword ascii
        $d13 = "De_lay" fullword ascii
        $d14 = "Anti_Process" fullword ascii
        $d15 = "An_ti" fullword ascii

        $dcrat = "DcRat" wide ascii

        // strings
        $s0 = "UmVjZWl2ZWQ=" fullword wide // Received
        $s1 = "YW1zaS5kbGw=" fullword wide // amsi.dll
        $s2 = "U09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVuXA==" fullword wide // SOFTWARE\Microsoft\Windows\CurrentVersion\Run\
        $s3 = "L2Mgc2NodGFza3MgL2NyZWF0ZSAvZiAvc2Mgb25sb2dvbiAvcmwgaGlnaGVzdCAvdG4g" fullword wide // /c schtasks /create /f /sc onlogon /rl highest /tn 
        $s4 = "/c schtasks /create /f /sc onlogon /rl highest /tn \"" fullword wide
        $s5 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\" fullword wide

        // camera class and interface IDs
        $cam0 = "CLSID_SystemDeviceEnum" fullword ascii
        $cam1 = "{860BB310-5D01-11d0-BD3B-00A0C911CE86}" fullword wide
        $cam2 = "CLSID_VideoInputDeviceCategory" fullword ascii
        $cam3 = "{62BE5D10-60EB-11d0-BD3B-00A0C911CE86}" fullword wide
        $cam4 = "IID_IPropertyBag" fullword ascii
        $cam5 = "{55272A00-42CB-11CE-8135-00AA004BB851}" fullword wide

        // GUIDs
        $g0 = "29840822-5B84-11D0-BD3B-00A0C911CE86" fullword ascii // ICreateDevEnum
        $g1 = "55272A00-42CB-11CE-8135-00AA004BB851" fullword ascii // IPropertyBag

        // batch file
        $b0 = /timeout [0-9] > NUL/ fullword wide
        $b1 = "@echo off" fullword wide
        $b2 = "START " fullword wide
        $b3 = "CD " fullword wide
        $b4 = "DEL " fullword wide
        $b5 = " /f /q" fullword wide
        $b6 = "START \"\" \"" fullword wide
        $b7 = "DEL \"" fullword wide
        $b8 = "\" /f /q" fullword wide

    condition:
        uint16(0) == 0x5a4d // PE file
        and filesize > 10KB
        and 11 of ($c*)
        and 11 of ($d*)
        and (
                $dcrat 
                or 
                (
                    2 of ($s*)
                    and all of ($cam*)
                    and all of ($g*)
                    and 6 of ($b*)
                )
            )	
}

rule MAL_DcRat_qwqdanchun2 {
    meta:
        author = "MKelly, Insikt Group, Recorded Future"
        date = "2023-03-16"
        description = "Detecting the open source backdoor DcRat authored by qwqdanchun"
        version = "1.0"
        reference = "https://github.com/qwqdanchun/DcRat"
        reference = "https://app.recordedfuture.com/live/sc/53QIlCnF8KWa"
        reference = "https://forensicitguy.github.io/snip3-crypter-dcrat-vbs/"
        reference = "https://blog.talosintelligence.com/crimeware-targets-afghanistan-india/"
        hash = "fadaea2a74d91876713f18cb85be639a6fbd94cff6587688afb6020025a0446b"
        hash = "c0c6c0eb38215512d07c0258dc0d80a1ae935f468400d5fefd75acd0b22424f5"
        hash = "2dfeaa56726face5d3bc0538b210ff90ef8966fb0930b2526db186f8e63dcffd"
        hash = "a1443c711a3047375418cbac55a2582ef3c6e1cc9690969c2fa707c9c4243f3a"
        RF_MALWARE = "DcRat (qwqdanchun version)"
        RF_MALWARE_ID = "qfQAi5"

    strings: 
        $s1 = "DcRat.Helper" wide
        $s2 = "System.Collections.Generic.IEnumerable<Client.HandlePacket.HandleDevice.TemporaryDeviceInfo>"
        $s3 = "$3b85814f-a51d-4572-9325-947c9e8d217b" // Assembly type library ID GUID observable in DcRat source code
        $s4 = "keyloggerSave" wide
        $s5 = "HandleRegEdit"
        $s6 = "HandleDesktops"
        $s7 = "WinSoundRecord"
        $s8 = "ExecuteNewDesktop"
        $s9 = "Recorder_DataRecorded" 
        $s10 = "Client.Helper.RegManager" 
        $s11 = "qwqdanchun" // Malware author handle
    condition: 
        uint16(0) == 0x5a4d and 
        (7 of ($s*)) 
} 
